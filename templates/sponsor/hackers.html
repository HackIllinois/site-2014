{% extends "sponsor/base/sponsor_base.html" %}
{% set active_page = "hackers" %}

{% block head %}
<style type="text/css">
    .page-header {
        margin-top: 0;
    }
    .t-centered {
        text-align: center;
    }
    .dropdown_buttons {
        margin-bottom: 20px;
    }
    table {
        table-layout: fixed;
    }
    td, th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    td:hover, th:hover {
        white-space: normal;
        overflow: visible;
        word-wrap:break-word;
    }
    .width100 {
        width:100%;
    }
    .t-centered {
        text-align: center;
    }
    .toggle-columns {
        margin-bottom: 20px;
    }
    .clickable {
        cursor: pointer;
    }
</style>
{% endblock head %}


{% block body %}
<div class="row">
    <div class="col-md-9">
		<h1 class="page-header">Hackers<small>&nbsp;&nbsp;</small><small id="count">{{ data.num_people }}</small><small>&nbsp;people</small></h1>
    </div>
	<div class="col-md-3">
        <a href="{{ data.export_url }}" role="button" class="btn btn-success btn-lg btn-block">Download as CSV</a>
    </div>
</div>

<div class="container-fluid">
    <div class="row toggle-columns">
        <div class="col-md-8">
            <label>Show columns:&nbsp;&nbsp;</label>
            <div class="btn-group" data-toggle="buttons">
                {% for name, text in [('email', 'Email'), ('school', 'School'), ('year', 'Year'), ('resume', 'Resume'), ('attending', 'Attending'), ('download', 'Download')] %}
                <label class="btn btn-default column-btn active">
                    <input type="checkbox" name="{{ name }}"> {{ text }}
                </label>
                {% endfor %}
            </div>
        </div><!-- col-md-8 -->
        <div class="col-md-4">
            <button id="download-button" class="btn btn-primary btn-block" data-loading-text="Thinking...">Download</button>
        </div>
    </div><!-- row -->

    <div class="row">
        <div class="col-md-12">
            <div id="hackers" class="table-responsive">
                <table id="usertable" class="table table-bordered table-hover table-condensed">
                    <thead>
                        <tr name="search_params">
                            <th name="tname"        ><input id="search_name"    type="text" class="width100" placeholder="Search Names" ></th>
                            <th name="temail"       ><input id="search_email"   type="text" class="width100" placeholder="Search Email" ></th>
                            <th name="tschool"      ><input id="search_school"  type="text" class="width100" placeholder="Search School"></th>
                            <th name="tyear"        ><input id="search_year"    type="text" class="width100" placeholder="Search Year"  ></th>
                            <th name="tresume">
                                <input type="checkbox" class="cresume" name="Has Resume"> Has Resume
                            </th>
                            <th name="tattending">
                                <input type="checkbox" class="cattending" name="Is Attending"> Is Attending
                            </th>
                            <th name="tdownload">
                                <!-- <input type="checkbox" class="cdownload" name="Download"> Download -->
                            </th>

                        </tr>
                        <tr>
                            <th name="tname"        class="sort" data-sort="name"       >Name</th>
                            <th name="temail"       class="sort" data-sort="email"      >Email</th>
                            <th name="tschool"      class="sort" data-sort="school"     >School</th>
                            <th name="tyear"        class="sort" data-sort="year"       >Year</th>
                            <th name="tresume"      class="sort" data-sort="resume"     >Resume</th>
                            <th name="tattending"   class="sort" data-sort="attending"  >Attending</th>
                            <th name="tdownload"    class="sort" data-sort="download"   >Download</th>
                        </tr>
                    </thead>
                    <tbody class="list">
                        {% for h in data.hackers %}
                        <tr name="hackerData" id="{{ h.userId }}">
                            <td                     class="id hidden"                   >{{ loop.index }}</td>
                            <td name="tname"        class="name clickable goto-profile" >{{ h.nameFirst }} {{ h.nameLast }}</td>
                            <td name="temail"       class="email clickable goto-profile">{{ h.email }}</td>
                            <td name="tschool"      class="school clickable"            >{{ h.school }}</td>
                            <td name="tyear"        class="year clickable"              >{{ h.year }}</td>
                            <td name="tresume"      class="resume"                      >{% if h.hasResume %}<a href='/corporate/resume?userId={{ h.userId }}'>Resume</a>{% endif %}</td>
                            <td name="tattending"   class="attending"                   >{% if h.isAttending %}Yes{% else %}No{% endif %}</td>
                            <td name="tdownload"    class="download"                    >
                                <input type="checkbox" class="download-checkbox">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <ul class="pagination"></ul>
            </div><!-- table-responsive -->
        </div><!-- col-md-12 -->
    </div><!-- row -->
</div><!-- container-fluid -->
{% endblock body %}


{% block scripts %}
<script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.1.0/list.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/list.pagination.js/0.1.0/list.pagination.min.js"></script>
<script type="text/javascript">
    var paginationOptions = {
        name: "pagination",
        paginationClass: "pagination",
        innerWindow: 2,
        outerWindow: 1
    };
    var options = {
        // http://listjs.com/docs/options
        valueNames: [ 'id', 'name', 'email', 'school', 'year', 'resume', 'attending' ],
        page: 20,
        plugins: [
            ListPagination(paginationOptions)
        ]
    };
    var hackerList = null;

    function colToggleCallbacks() {
        $('.column-btn').click(function () {
            var name = $(this).find('input').attr('name'),
                q = '[name="t' + name + '"]';
            if ($(this).hasClass('active')) {
                $(q).addClass("hidden");
            } else {
                $(q).removeClass("hidden");
            }
        });
    }

    function updateColumVisibility() {
        $('.column-btn').each(function(index) {
            var name = $(this).find('input').attr('name'),
                q = '[name="t' + name + '"]';
            if ($(this).hasClass('active')) {
                $(q).removeClass("hidden");
            } else {
                $(q).addClass("hidden");
            }
        });
    }

    function searchCallbacks() {
        $('#search_name').keyup(function() {
            hackerList.search($('#search_name').val(), ['name']);
        });
        $('#search_email').keyup(function() {
            hackerList.search($('#search_email').val(), ['email']);
        });
        $('#search_school').keyup(function() {
            hackerList.search($('#search_school').val(), ['school']);
        });
        $('#search_year').keyup(function() {
            hackerList.search($('#search_year').val(), ['year']);
        });
    }

    function schoolClickCallbacks() {
        $('.school').click(function () {
            $('#search_school').val($(this).html());
            hackerList.search($('#search_school').val(), ['school']);
        });
    }

    function yearClickCallbacks() {
        $('.year').click(function () {
            $('#search_year').val($(this).html());
            hackerList.search($('#search_year').val(), ['year']);
        });
    }

    function checkBoxCallback() {
        var resume_checked = $('.cresume').prop('checked');
        var attending_checked = $('.cattending').prop('checked');
        hackerList.filter(function(item) {
            var res = item.values().resume,
                att = item.values().attending;
            if (resume_checked && attending_checked) {
                return res != null && res != '' && att != null && att != '' && att != 'No';
            } else if (resume_checked) {
                return res != null && res != '';
            } else if (attending_checked) {
                return att != null && att != '' && att != 'No';
            } else {
                return true;
            }
        });
    }

    function checkBoxCallbacks() {
        $('.cresume').click(checkBoxCallback);
        $('.cattending').click(checkBoxCallback);
    }

    function profileClickCallbacks() {
        $('.goto-profile').click(function () {
            var id = $(this).closest('tr').get(0).id
            document.location = '/corporate/hackers/' + id;
        });
    }

    function getDownloadChecked() {
        var download_checked = $('.download-checkbox:checked').map(function () {
            return $(this).closest('tr').get(0).id
        }).get();
        return download_checked;
    }

    // http://rohanradio.com/blog/2011/02/22/posting-json-with-jquery/
    jQuery.extend({
        postJSON: function(params) {
            return jQuery.ajax(jQuery.extend(params, {
                type: "POST",
                data: JSON.stringify(params.data),
                dataType: "json",
                contentType: "application/json",
                processData: false
            }));
        }
    });

    function downloadButtonCallback() {
        $('#download-button').click(function () {
            checked = getDownloadChecked();

            $("#download-button").button('loading');

            request = $.postJSON({
                url: '/corporate/hackers',
                data: {ids: checked},
            });

            request.done(function(data) {
                $("#download-button").button('reset');
                window.location.href = "/corporate/queue";
            });
            request.fail(function( jqXHR, textStatus ) {
                alert( "Request failed: " + textStatus );
                $("#download-button").button('reset');
            });
        });
    }

    $(document).ready(function () {
        hackerList = new List('hackers', options);

        schoolClickCallbacks();
        yearClickCallbacks();
        colToggleCallbacks();
        searchCallbacks();
        checkBoxCallbacks();
        profileClickCallbacks();
        downloadButtonCallback();

        $('#count').html(hackerList.matchingItems.length);
        hackerList.on('updated', function() {
            $('#count').html(hackerList.matchingItems.length);
            updateColumVisibility();
            schoolClickCallbacks();
            yearClickCallbacks();
            profileClickCallbacks();
        });


    });
</script>
{% endblock scripts%}
