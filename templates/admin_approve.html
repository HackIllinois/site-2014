{% extends "base/admin_base.html" %}
{% set active_page = "approve" %}

{% block head %}
    <style type="text/css">
        .page-header {
            margin-top: 0;
        }
        .t-centered {
            text-align: center;
        }
        .dropdown_button {
            margin-bottom: 20px;
        }

        table {
            table-layout: fixed;
        }
        td, th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        td:hover, th:hover {
            white-space: normal;
            overflow: visible;
            word-wrap:break-word;
        }
        .width100 {
            width:100%;
        }
        .t-centered {
            text-align: center;
        }
        .toggle-columns {
            margin-bottom:20px;
        }
    </style>
{% endblock head %}


{% block body %}
    <div class="row">
        <div class="col-md-9">
            <h1 class="page-header">Hacker Summary<small>&nbsp;&nbsp;</small><small id="count">{{ data.num_people }}</small><small>&nbsp;people</small></h1>
        </div>
        <div class="col-md-3">
            <a href="/admin/export" role="button" class="btn btn-success btn-lg btn-block">Download All as CSV</a>
        </div>
    </div>

    <div class="row dropdown_button">
        <div class="col-md-12">
            <!-- Single button -->
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                    {{ data.dropdown_button_text }}&nbsp;&nbsp;<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li role="presentation"><a role="menuitem" href="/admin/approve">Show all</a></li>
                    <li role="presentation" class="divider"></li>
                    <li role="presentation" class="dropdown-header">Categories</li>
                    {% for c in data.categories %}
                    <li role="presentation"><a role="menuitem" href="{{ c.link }}">{{ c.text }}</a></li>
                    {% endfor %}
                    <li role="presentation" class="divider"></li>
                    <li role="presentation" class="dropdown-header">Bus Routes</li>
                    {% for r in data.routes %}
                    <li role="presentation"><a role="menuitem" href="{{ r.link }}">{{ r.text }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

<div class="container-fluid">

<div class="row toggle-columns">
<div class="col-md-12">

<label>Show columns:&nbsp;&nbsp;</label>
<div class="btn-group" data-toggle="buttons">
    {% for name, text in [('school', 'School'), ('linkedin', 'LinkedIn'), ('github', 'Github'), ('project', 'Project Type'), ('resume', 'Resume'), ] %}
    <label class="btn btn-default column-btn active">
        <input type="checkbox" name="{{ name }}"> {{ text }}
    </label>
    {% endfor %}
</div>

</div><!-- col-md-12 -->
</div><!-- row -->

<div class="row">
<div class="col-md-12">

<div id="hackers" class="table-responsive">
    <table id="usertable" class="table table-bordered table-hover table-condensed">
        <thead>
            <tr name="search_params">
                <th                 ><input id="search_name"   type="text" class="width100" placeholder="Search Names" ></th>
                <th name="tschool"  ><input id="search_school" type="text" class="width100" placeholder="Search School"></th>
                <th name="tlinkedin"></th>
                <th name="tgithub"  ></th>
                <th name="tproject">
                    <input type="checkbox" class="cproject" name="Software Hack" checked> Software Hack<br>
                    <input type="checkbox" class="cproject" name="Hardware Hack" checked> Hardware Hack<br>
                    <input type="checkbox" class="cproject" name="Unsure"        checked> Unsure
                </th>
                <th name="tresume">
                    <input type="checkbox" class="cresume" name="Has Resume"> Has Resume
                </th>
                <th></th>
            </tr>
            <tr>
                <th name="tname"     class="sort" data-sort="name"   >Name</th>
                <th name="tschool"   class="sort" data-sort="school" >School</th>
                <th name="tlinkedin"                                 >LinkedIn</th>
                <th name="tgithub"                                   >Github</th>
                <th name="tproject"  class="sort" data-sort="project">Project Type</th>
                <th name="tresume"                                   >Resume</th>
                <th name="tapprove"                                  >Approve</th>
            </tr>
        </thead>
        <tbody class="list">
            {% for h in data.hackers %}
            <tr name="hackerData" id="{{ h.userId }}">
                <td                  class="id"     style="display:none;">{{ loop.index }}</td>
                <td name="tname"     class="name"   onclick="document.location='/admin/profile/{{ h.userId }}';">{{ h.nameFirst }} {{ h.nameLast }}</td>
                <td name="tschool"   class="school"  >{{ h.school }}</td>
                <td name="tlinkedin" class="linkedin">{{ h.linkedin }}</td>
                <td name="tgithub"   class="github"  >{{ h.github }}</td>
                <td name="tproject"  class="project" >{{ h.projectType }}</td>
                <td name="tresume"   class="resume"  >{% if h.resume %}<a href='/admin/resume?userId={{ h.userId }}'>Resume</a>{% endif %}</td>
                {% if h.isApproved%}
                <td name="tapprove"  class="approved"><button class="btn btn-danger approve-btn width100">Un-Approve</button></td>
                {% else %}
                <td name="tapprove"  class="approved"><button class="btn btn-success approve-btn width100">Approve</button></td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <ul class="pagination"></ul>
</div><!-- table-responsive -->

</div><!-- col-md-12 -->
</div><!-- row -->

</div><!-- container-fluid -->

{% endblock body %}


{% block scripts %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.1.0/list.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.pagination.js/0.1.0/list.pagination.min.js"></script>
    <script type="text/javascript">
        var paginationOptions = {
            name: "pagination",
            paginationClass: "pagination",
            innerWindow: 2,
            outerWindow: 1
        };
        var options = {
            // http://listjs.com/docs/options
            valueNames: [ 'id', 'name', 'school', 'project', 'resume' ],
            indexAsync: true,
            page: 20,
            plugins: [
                ListPagination(paginationOptions)
            ]
        };
        var hackerList = null;

        function colToggleCallbacks() {
            $('.column-btn').click(function () {
                name = $(this).find('input').attr('name')
                if ($(this).hasClass('active')) {
                    $('[name="t' + name + '"]').addClass("hidden");
                } else {
                    $('[name="t' + name + '"]').removeClass("hidden");
                }
            });
        }

        function applyBtnCallbacks() {
            $('.approve-btn').click(function () {
                var itemName = $(this).closest('tr').find('.name').text(),
                    itemuserId = $(this).closest('tr')[0].id,
                    approve = $(this).html(),
                    r = confirm(approve + " " + itemName + "?");
                if (r == true) {
                    if (approve == "Approve") {
                        $.post("/admin/approve", {"userId": itemuserId, "isApproved": "True"});
                        $(this).html("Un-Approve");
                        $(this).removeClass("btn-success").addClass("btn-danger");
                    } else {
                        $.post("/admin/approve", {"userId": itemuserId, "isApproved": "False"});
                        $(this).html("Approve");
                        $(this).removeClass("btn-danger").addClass("btn-success");
                    }
                }
            });
        }

        function searchCallbacks() {
            $('#search_name').keyup(function() {
                hackerList.search($('#search_name').val(), ['name']);
            });
            $('#search_school').keyup(function() {
                hackerList.search($('#search_school').val(), ['school']);
            });
        }

        function schoolClickCallbacks() {
            $('.school').click(function () {
                $('#search_school').val($(this).html());
                hackerList.search($('#search_school').val(), ['school']);
            });
        }

        function checkBoxCallback() {
            var project_checked = $('.cproject:checked').map(function () {
                return $(this).attr('name');
            }).get();
            var resume_checked = $('.cresume').prop('checked');
            hackerList.filter(function(item) {
                var proj = item.values().project,
                    res = item.values().resume;
                if (resume_checked) {
                    return res != null && res != '' && jQuery.inArray(proj, project_checked) != -1;
                } else {
                    return jQuery.inArray(proj, project_checked) != -1;
                }
            });
        }

        function projectCheckBoxCallbacks() {
            $('.cproject').click(checkBoxCallback);
        }

        function resumeCheckBoxCallback() {
            $('.cresume').click(checkBoxCallback);
        }

        $(document).ready(function () {
            hackerList = new List('hackers', options);

            applyBtnCallbacks();
            colToggleCallbacks();
            searchCallbacks();
            schoolClickCallbacks();
            projectCheckBoxCallbacks();
            resumeCheckBoxCallback();

            $('#count').html(hackerList.size());
            hackerList.on('searchComplete', function(){$('#count').html(hackerList.size());});
        });
    </script>
{% endblock scripts%}